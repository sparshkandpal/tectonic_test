<div class="admin-container">
  <div class="admin-header">
    <h1>Edit Dish</h1>
    <%= link_to 'Back to Stories', stories_path, class: 'back-link' %>
  </div>

  <%= form_with model: @dish, local: true, multipart: true, class: 'dish-form' do |form| %>
    <% if @dish.errors.any? %>
      <div class="error-messages">
        <h2><%= pluralize(@dish.errors.count, "error") %> prohibited this dish from being saved:</h2>
        <ul>
          <% @dish.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :restaurant_id, "Restaurant" %>
      <%= form.collection_select :restaurant_id, @restaurants, :id, :name, {}, { class: 'form-control' } %>
    </div>

    <div class="form-group">
      <%= form.label :name %>
      <%= form.text_field :name, class: 'form-control' %>
    </div>

    <div class="form-group">
      <%= form.label :description %>
      <%= form.text_area :description, rows: 4, class: 'form-control' %>
    </div>

    <div class="form-group">
      <%= form.label :base_price %>
      <%= form.number_field :base_price, step: 0.01, class: 'form-control' %>
    </div>

    <div class="form-group">
      <%= form.label :image, "Dish Image" %>
      <%= form.file_field :image, accept: 'image/*', class: 'form-control' %>
      <% if @dish.image.attached? %>
        <div class="image-preview">
          <%= image_tag @dish.image, style: 'max-width: 200px; margin-top: 10px;' %>
          <p class="image-note">Current image (upload new to replace)</p>
        </div>
      <% end %>
    </div>

    <div class="form-actions">
      <%= form.submit 'Update Dish', class: 'btn btn-primary' %>
    </div>
  <% end %>

  <div class="dish-ingredients-section">
    <h2>Dish Ingredients</h2>
    <%= link_to 'Add Ingredient', new_dish_dish_ingredient_path(@dish), class: 'btn btn-secondary' %>
    
    <div class="ingredients-list">
      <% @dish.dish_ingredients.includes(:ingredient).each do |dish_ingredient| %>
        <div class="ingredient-item">
          <div class="ingredient-info">
            <h4><%= dish_ingredient.ingredient.name %></h4>
            <p>Default Quantity: <%= dish_ingredient.default_quantity %></p>
            <p>Customizable: <%= dish_ingredient.is_customizable ? 'Yes' : 'No' %></p>
            <p>Extra Cost: <%= number_to_currency(dish_ingredient.extra_cost) %></p>
          </div>
          <div class="ingredient-actions">
            <%= link_to 'Edit', edit_dish_dish_ingredient_path(@dish, dish_ingredient), class: 'btn btn-small' %>
            <%= link_to 'Remove', dish_dish_ingredient_path(@dish, dish_ingredient), method: :delete, 
                confirm: 'Are you sure?', class: 'btn btn-small btn-danger' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= render 'dishes/form_styles' %>

